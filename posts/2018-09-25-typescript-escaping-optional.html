<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>TypeScript performance tip—Escaping partial</title><meta name="description" content="Simplex Sigillum Veri"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="canonical" href="https://remusao.github.io/posts/typescript-escaping-optional.html"><link rel="icon" type="image/x-icon" href="/images/favicon.ico"><style type="text/css">body{color:#2f2f2f;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen-Sans,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;line-height:1.6em;margin:20px auto;max-width:40rem;padding:0 1.5em;text-rendering:optimizeLegibility}h1,h2,h3{padding-top:.7em}h2{border-bottom:1px solid #eaecef;padding-bottom:.5em}.header,.main figcaption{color:#555;font-style:italic}.main a{color:#3465a4}.main a:visited{color:#75507b}.main figcaption{color:#696f72;line-height:2em;text-align:center}.main img{display:block;height:auto;margin:auto;padding-bottom:1em;padding-top:1em;width:90%}.main blockquote{border-left:thin solid #d3d7cf;color:#555;margin:10px;padding:0 0 0 1em}code{background-color:#f6f8fa;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:14px;line-height:20px;padding:.2em .4em}pre code{display:block;overflow-x:auto}.leave-comment-btn,summary{font-size:16px;font-weight:600}.leave-comment-btn{background-color:#28a745;background-image:linear-gradient(-180deg,#34d058,#28a745 90%);border:1px solid rgba(27,31,35,.2);border-radius:.25em;color:#fff;display:inline-block;margin-top:1.5em;padding:3px 10px;text-decoration:none}.leave-comment-btn:hover{box-shadow:0 1px 3px rgba(0,0,0,.24)}summary{color:#516ae8;cursor:pointer;line-height:1.2rem;margin-top:2rem}.comments-list{list-style:none;padding:0}.comment{background-color:#fff;border:1px solid #d1d5da;border-radius:3px;color:#24292e;font-size:16px;margin:1em 0}.meta{background-color:#f6f8fa;border-bottom:1px solid #d1d5da;color:#586069}.author,.date{text-decoration:none}.author{color:#24292e!important;font-weight:700}.date{color:#586069}.date:hover{color:#0366d6}.content{padding-left:20px}.avatar,.emoji{vertical-align:middle}.avatar{display:inline-block;margin-right:5px}.emoji{height:1.1em;width:1.1em}table{border-collapse:collapse;margin:auto}td,th{border:1px solid #ddd;padding:10px}tr:hover{background-color:#f5f5f5}footer{border-top:thin solid #d3d7cf;margin:1.5em 0}.share ul{text-align:right}.share li{display:inline;padding:0 5px}.share img{width:2em}.main a,header a{text-decoration:none}.hljs{background:#f8f8f8;color:#333;display:block;overflow-x:auto;padding:.5em}.hljs-comment,.hljs-quote{color:#6a737d;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#d73a49}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:#005cc5}.hljs-doctag,.hljs-string{color:#032f62}.hljs-section,.hljs-selector-id,.hljs-title{color:#900}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#6f42c1}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style></head><body><main><header><h1><a href="../"><span>../</span></a></h1></header><h1>TypeScript performance tip—Escaping partial</h1><section class="header"><div>2018-09-25 | <em>Reading time: ~5 minutes</em></div></section><article><div class="main"><p>A common pattern in JavaScript or TypeScript is to pass options to a function or constructor as an object with optional attributes (meaning, only a subset of the attributes can be specified). Since v2.1, TypeScript offers a great way to make this type-safe in the form of <code>Partial&lt;T&gt;</code> which allows to specify a type for exactly this pattern. In practice this looks like:</p><pre><code class="language-javascript">interface IOptions {
  <span class="hljs-attr">option1</span>: boolean;
  option2: string;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doSomething</span>(<span class="hljs-params">options: Partial&lt;IOptions&gt; = {}</span>): <span class="hljs-title">void</span> </span>{
  ...
}</code></pre><p>This definition allows to give a subset of the options to the function, or all of them, or no argument at all!</p><pre><code class="language-javascript">doSomething(); <span class="hljs-comment">// OK</span>
doSomething({ <span class="hljs-attr">option1</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// OK</span>
doSomething({ <span class="hljs-attr">option1</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">option2</span>: <span class="hljs-string">'foo'</span> }); <span class="hljs-comment">// OK</span>

doSomething({ <span class="hljs-attr">option3</span>: <span class="hljs-number">42</span> }); <span class="hljs-comment">// NOT OK</span></code></pre><p>Now, something you might want to do is to provide a set of default values for each attribute of your <code>IOptions</code> passed as argument. One way this could be done is to use <code>Object.assign</code> to merge the partial options given as argument with a set of default values:</p><pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDefaults</span>(<span class="hljs-params">options: Partial&lt;IOptions&gt; = {}</span>): <span class="hljs-title">IOptions</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.assign({
    <span class="hljs-attr">option1</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">option2</span>: <span class="hljs-string">'bar'</span>,
  }, options);
}</code></pre><p>This is elegant and it works. However, this is not the optimal solution in terms of performance. There is still some overhead in the call to <code>assign</code>, and although it might not matter most of the time, sometimes you just want to make things go as fast as possible. As a baseline, let’s measure the performance of this solution using the <a href="https://www.npmjs.com/package/benchmark">benchmark</a> library:</p><blockquote><p><strong>14M</strong> calls/second</p></blockquote><p>To by-pass the use of <code>Object.assign</code>, we could try to use the spread operator:</p><pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDefaults</span>(<span class="hljs-params">options: Partial&lt;IOptions&gt; = {}</span>): <span class="hljs-title">IOptions</span> </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">option1</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">option2</span>: <span class="hljs-string">'bar'</span>,
    ...options,
  };
}</code></pre><p>This is even terser, but unfortunately it’s not as fast, at least when <code>esnext</code> is targeted. For <code>ES6</code> or lower, a call to <code>Object.assign</code> will be made, which makes this solution equivalent to the first one.</p><blockquote><p><strong>7M</strong> calls/second (<strong>x0.6</strong>)</p></blockquote><p>Another solution would be to hard-code the creation of the object with the existence of each attribute checked:</p><pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDefaults</span>(<span class="hljs-params">options?: Partial&lt;IOptions&gt;</span>): <span class="hljs-title">IOptions</span> </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">option1</span>: options.option1 !=== <span class="hljs-literal">undefined</span> ? options.options1 : <span class="hljs-literal">true</span>,
    <span class="hljs-attr">option2</span>: options.option2 !=== <span class="hljs-literal">undefined</span> ? options.options2 : <span class="hljs-string">'bar'</span>,
  };
}</code></pre><p>This does the job, but is much more verbose, and you will have to write the name of each attribute several times. It does not get better as your option type grows. The performance is much better though:</p><blockquote><p><strong>215M</strong> calls/second (<strong>x15</strong>)</p></blockquote><p>If you already looked at the code generated by Babel or TypeScript to transpile arguments destructuring, this should look familiar. We could try to make TypeScript generate the boilerplate code for us by targeting an older version of ECMAScript (which does not support destructuring). On top of that, destructuring allows to specify default values for some (or all) of the attributes. Let’s combine these two ideas to create a fourth version of our <code>setDefaults</code> function:</p><pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDefaults</span>(<span class="hljs-params">{
  option1 = true,
  option2 = <span class="hljs-string">'bar'</span>,
}: Partial&lt;IOptions&gt; = {}</span>): <span class="hljs-title">IOptions</span> </span>{
  <span class="hljs-keyword">return</span> { option1, option2 };
}</code></pre><p>This is almost as terse as the first version based on <code>Object.assign</code> and much better than the second version. It is also the fastest version:</p><blockquote><p><strong>230M</strong> calls/second (<strong>x16</strong>)</p></blockquote><p>Out of curiosity, we can check the code generated by TypeScript depending on the <code>target</code> you specify. Keep in mind that the performance seen above corresponds to the <code>ES3</code> target.</p><ul><li><strong>ES3 and ES5</strong></li></ul><pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDefaults</span>(<span class="hljs-params">_a</span>) </span>{
  <span class="hljs-keyword">var</span> _b = _a === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> ? {} : _a, _c = _b.option1, option1 = _c === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> ? <span class="hljs-literal">true</span> : _c, _d = _b.option2, option2 = _d === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> ? <span class="hljs-string">'bar'</span> : _d;
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">option1</span>: option1, <span class="hljs-attr">option2</span>: option2 };
}</code></pre><p>Yey, fast and ugly!</p><blockquote><p><strong>230M</strong> calls/second (<strong>x16</strong>)</p></blockquote><ul><li><strong>ES6</strong></li></ul><pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDefaults</span>(<span class="hljs-params">{ option1 = true, option2 = <span class="hljs-string">'bar'</span>, } = {}</span>) </span>{
  <span class="hljs-keyword">return</span> { option1, option2 };
}</code></pre><p>Yey, nice and not as fast…</p><blockquote><p><strong>170M</strong> calls/second (<strong>x12</strong>)</p></blockquote><p>Here we can see that the implementation of <code>ES6</code> destructuring with defaults is not yet as fast as the transpiled version, at least on V8 (Node.js 10.11.0). In practice that is not an issue as TypeScript will allow you to write high-level, type-safe code, while still giving you the best performance by targeting low-level JavaScript (e.g.: <code>ES3</code>!).</p><p>The full source-code for benchmarks can be found there: <a href="../snippets/typescript-options-bench.ts">typescript-options-bench.ts</a>. All the results were obtained using Node.js v10.11.0 on an Intel i7-6600U (2,60-3,40 GHz) with 16GB of Ram, running Ubuntu 18.04.</p></div><div class="comments"></div></article><footer><div class="share"><ul><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://remusao.github.io//posts/typescript-escaping-optional.html&t=TypeScript performance tip—Escaping partial" title="Share on Facebook" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Share on Facebook" src="/images/social_flat_rounded_rects_svg/Facebook.svg"><a></a></li><li><a href="https://twitter.com/share?url=https://remusao.github.io//posts/typescript-escaping-optional.html&text=TypeScript performance tip—Escaping partial&via=Pythux" title="Tweet" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Tweet" src="/images/social_flat_rounded_rects_svg/Twitter.svg"><a></a></li><li><a href="https://getpocket.com/save?url=https://remusao.github.io//posts/typescript-escaping-optional.html&title=TypeScript performance tip—Escaping partial" title="Add to Pocket" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Add to Pocket" src="/images/social_flat_rounded_rects_svg/Pocket.svg"><a></a></li><li><a href="https://news.ycombinator.com/submitlink?u=https://remusao.github.io//posts/typescript-escaping-optional.html&t=TypeScript performance tip—Escaping partial" title="Submit to Hacker News" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Hacker News" src="/images/social_flat_rounded_rects_svg/HackerNews.svg"><a></a></li><li><a href="https://www.reddit.com/submit?url=https://remusao.github.io//posts/typescript-escaping-optional.html&title=TypeScript performance tip—Escaping partial" title="Submit to Reddit" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Reddit" src="/images/social_flat_rounded_rects_svg/Reddit.svg"><a></a></li></ul></div></footer></main></body></html>