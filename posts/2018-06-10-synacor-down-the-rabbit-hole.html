<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Synacor - Down the Rabbit Hole</title><meta name="description" content="Simplex Sigillum Veri"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="canonical" href="https://remusao.github.io/posts/synacor-down-the-rabbit-hole.html"><link rel="icon" type="image/x-icon" href="/images/favicon.ico"><style type="text/css">body{color:#2f2f2f;font-family:'Palatino Linotype',Palatino,Palladio,'URW Palladio L','Book Antiqua',Baskerville,'Bookman Old Style','Bitstream Charter','Nimbus Roman No9 L',Garamond,'Apple Garamond','ITC Garamond Narrow','New Century Schoolbook','Century Schoolbook','Century Schoolbook L',Georgia,serif;font-size:18px;line-height:1.6em;margin:20px auto;max-width:40rem;padding:0 1.5em;text-rendering:optimizeLegibility}h1,h2,h3{padding-top:.7em}.header,.main figcaption{color:#555;font-style:italic}.main a{color:#3465a4}.main a:visited{color:#75507b}.main figcaption{color:#696f72;line-height:2em;text-align:center}.main img{display:block;height:auto;margin:auto;padding-bottom:1em;padding-top:1em;width:90%}.main blockquote{border-left:thin solid #d3d7cf;color:#555;margin:10px;padding:0 0 0 1em}code{background-color:#f3f4f5;font-family:Consolas,'Andale Mono WT','Andale Mono','Lucida Console','Lucida Sans Typewriter','DejaVu Sans Mono','Bitstream Vera Sans Mono','Liberation Mono','Nimbus Mono L',Monaco,'Courier New',Courier,monospace;font-size:14px;line-height:1.2em}pre code{display:block;overflow-x:auto;padding:8px}.leave-comment-btn,summary{font-size:16px;font-weight:600}.leave-comment-btn{background-color:#28a745;background-image:linear-gradient(-180deg,#34d058,#28a745 90%);border:1px solid rgba(27,31,35,.2);border-radius:.25em;color:#fff;display:inline-block;margin-top:1.5em;padding:3px 10px;text-decoration:none}.leave-comment-btn:hover{box-shadow:0 1px 3px rgba(0,0,0,.24)}summary{color:#516ae8;cursor:pointer;line-height:1.2rem;margin-top:2rem}.comments-list{list-style:none;padding:0}.comment{background-color:#fff;border:1px solid #d1d5da;border-radius:3px;color:#24292e;font-size:16px;margin:1em 0}.meta{background-color:#f6f8fa;border-bottom:1px solid #d1d5da;color:#586069}.author,.date{text-decoration:none}.author{color:#24292e!important;font-weight:700}.date{color:#586069}.date:hover{color:#0366d6}.content{padding-left:20px}.avatar,.emoji{vertical-align:middle}.avatar{display:inline-block;margin-right:5px}.emoji{height:1.1em;width:1.1em}table{border-collapse:collapse;margin:auto}td,th{border:1px solid #ddd;padding:10px}tr:hover{background-color:#f5f5f5}footer{border-top:thin solid #d3d7cf;margin:1.5em 0}.share ul{text-align:right}.share li{display:inline;padding:0 5px}.share img{width:2em}.main a,header a{text-decoration:none}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag{color:#333;font-weight:700}.hljs-subst{color:#333}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style></head><body><main><header><h1><a href="../"><span>../</span></a></h1></header><h1>Synacor - Down the Rabbit Hole</h1><section class="header"><div>2018-06-10 | <em>Reading time: ~8 minutes</em></div></section><article><div class="main"><p>Last year I had the chance to participate in the 2017 edition of <a href="https://adventofcode.com/">Advent of Code</a>. That was the first time and I <em>really</em> enjoyed it. Having to solve an interesting problem, every day, made me learn a lot! It’s also a good occasion to practice some skills that might not be otherwise useful in your daily job (and more importantly: have fun!).</p><p>While skimming through the discussions on Reddit about possible solutions to one of the AoC’s problems, someone mentioned “Synacor”… I never heard of it before, but from what I understood it was some kind of programming challenge. I did not need more to have a look: <a href="https://challenge.synacor.com">challenge.synacor.com</a>.</p><h1 id="the-challenge">The Challenge</h1><p>The challenge is briefly introduced, the competition took place during two conferences in the past and is now over. But you can still download the material of the challenge and try to solve it.</p><p>After registering an email address and a password, I could download an archive <code>synacor-challenge.tgz</code>. Uncompressed, it contains two files :</p><ol><li><code>arch-spec</code></li><li><code>challenge.bin</code></li></ol><p>The first one describes the challenge. It is about creating “a virtual machine capable of running the included binary [challenge.bin]”. It also mentions that some “codes” are to be found along the way. The rest of the document describes the architecture of the virtual machine:</p><ul><li>16 bits integers stored in little-endian format</li><li>16 bits addressable memory (the program starts at address <code>0</code>)</li><li>8 registers</li><li>1 stack containing 16 bits numbers</li><li>22 instructions: <code>halt</code>, <code>noop</code>, <code>set</code>, <code>push</code>, <code>jpm</code>, <code>add</code>, <code>mult</code>, etc.</li></ul><p>Each instruction is described in details: opcode, number of expected arguments and behavior when executed by the virtual machine. So far so good, this looks pretty classic. The implementation of such virtual machine is pretty straight forward. I choose <code>Haskell</code> for the implementation (because why not, and I already implemented some <a href="https://github.com/remusao/Hodor">Brainfuck interpreter/transpiler</a> before, so I thought I could reuse some learnings from there). Without going into too much details, I used the following data structures to represent the state of the VM:</p><pre><code class="language-haskell"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Synacor</span> = <span class="hljs-type">Synacor</span></span>
  { pos :: <span class="hljs-type">Int</span>
  , mem :: <span class="hljs-type">Map</span> <span class="hljs-type">Register</span> <span class="hljs-type">Word16</span>
  , stack :: [<span class="hljs-type">Word16</span>]
  , program :: <span class="hljs-type">Vector</span> <span class="hljs-type">Word16</span>
  }</code></pre><h1 id="first-results">First Results</h1><p>After implementing most of the instructions, I tried to run the program:</p><blockquote><p>Welcome to the Synacor Challenge! Please record your progress by putting codes like this one into the challenge website: XXXXXXXXXXX</p><p>Executing self-test…</p></blockquote><p>Nice, so the program actually starts by <em>testing the virtual machine</em>, to make sure all instructions are implemented properly. It’s pretty cool. It means that you cannot proceed until your VM is fully functional (Using Haskell is a good start for that…). After a few iterations of trial, error, fix, I completed my implementation until…</p><blockquote><p>self-test complete, all tests pass The self-test completion code is: XXXXXXXXXXXX</p></blockquote><p>Youpi! All good… but, wait, something else was displayed on the terminal:</p><p><strong>DISCLAIMER</strong>: The next section of this post contains spoilers and parts of solutions for the Synacor challenge. Please only proceed if you already solved the challenge, or do not intend to do so.</p><p>…</p><h1 id="riddles-in-the-dark">Riddles in the Dark</h1><blockquote><p>== Foothills == You find yourself standing at the base of an enormous mountain. At its base to the north, there is a massive doorway. A sign nearby reads “Keep out! Definitely no treasure within!”</p><p>Things of interest here:</p><ul><li>tablet</li></ul><p>There are 2 exits:</p><ul><li>doorway</li><li>south</li></ul><p>What do you do?</p></blockquote><p><em>Mind blown</em>. The program you are running is actually a terminal-based RPG! How cool is that? Well, very cool, and very smart. I clearly did not expect that from the challenge. It’s a bit like trying to open a chess (the chess is a program and the virtual machine is the key) and then you discover there is another riddle in the chess. So what’s next? Well play the game I guess…</p><p>I played for a bit, and discovered one more code in the game (Did I already mention how cool all this is?). Which means some (all?) codes can be found by playing the game. But then, how do I know if all codes are in the game? How deep and rich can this game be? What if it takes 10 hours to find the codes? I already under-estimated the challenge once, let’s not do the same mistake again.</p><p>At this point I thought of two things that could be done:</p><ol><li>Try to extract all text from the file <code>challenge.bin</code> and see if it contains any code.</li><li>Modify the VM so that it can play the game by itself, and explore all possible paths possible, some kind of depth-first search on the game itself in a way.</li><li>Disassemble the program and try to understand its structure. The codes must be stored somewhere (or generated somehow), by understanding (and maybe changing a bit) the code, it must be possible to bypass the game completely.</li></ol><p>The first approach did not yield any result, which means that codes are probably encoded in some way to not be readable. I did not have too much hope anyways, but we never know.</p><p>The second approach was the most promising and allowed me to discover a few more codes. Here is how it worked:</p><p><strong>First step</strong> – I modified the virtual machine implementation so that it’s 100% pure code with no side-effect. The execution now consists in a function <code>execNextOpCode</code> which takes as input the state of the program, runs the next opcode of the program, then returns a “continuation” which can be one of:</p><ul><li><code>Halt</code> - program terminated successfully.</li><li><code>Error String</code> - there was an exception while running the opcode (should never happen).</li><li><code>PutChar Char</code> - we should print a character in the terminal.</li><li><code>GetChar (Char -&gt; s)</code> - we should ask some user input, then continue the execution of the opcode using the function returned (<code>Char -&gt; s</code>).</li><li><code>Ok</code> - opcode was executed correctly and we can continue running the program.</li></ul><p>The nice thing with this model, is that running an opcode does not alter the state of the virtual machine, but instead returns a new virtual machine (copy of the initial state). This might seem crazy, but it’s not as inefficient as it sounds (and pretty common in an immutable language like Haskell). This allows us to parallelize the execution of different branches of a program without having to care about controlling side-effects.</p><p><strong>Second step</strong> – write a depth-first search for the game by changing the VM execution model in two ways:</p><ol><li>Each output <code>PutChar</code> from the program is stored in an accumulator so that we can inspect it later.</li><li>Each time a user input is required by the <code>GetChar</code> continuation code, we <em>fork</em> our execution of the program and perform all possible user actions concurrently: <em>picking up objects</em>, <em>using objects</em>, *visit available places*.</li><li>We need to detect loops to not explore forever (e.g.: when we come back to an already visited location). This is done by comparing the output (accumulated <code>PutChar</code> from the program) of a given branch to all previously explored branches. If we already generated the same output once, no need to do it again.</li></ol><p>This approach allowed me to discover a few more codes, <em>but not all</em>! This can mean two things: either not all codes can be discovered through the game (likely), or my exploration method is not working as well as it should! In both cases, it means I’m not done exploring the rabbit hole…</p></div><div class="comments"><span><a class="leave-comment-btn" href="https://github.com/remusao/remusao.github.io/issues/14" title="https://github.com/remusao/remusao.github.io/issues/14" target="_blank" rel="noopener noreferrer">Leave a comment on GitHub</a></span></div></article><footer><div class="share"><ul><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://remusao.github.io//posts/synacor-down-the-rabbit-hole.html&t=Synacor - Down the Rabbit Hole" title="Share on Facebook" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Share on Facebook" src="/images/social_flat_rounded_rects_svg/Facebook.svg"><a></a></li><li><a href="https://twitter.com/share?url=https://remusao.github.io//posts/synacor-down-the-rabbit-hole.html&text=Synacor - Down the Rabbit Hole&via=Pythux" title="Tweet" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Tweet" src="/images/social_flat_rounded_rects_svg/Twitter.svg"><a></a></li><li><a href="https://getpocket.com/save?url=https://remusao.github.io//posts/synacor-down-the-rabbit-hole.html&title=Synacor - Down the Rabbit Hole" title="Add to Pocket" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Add to Pocket" src="/images/social_flat_rounded_rects_svg/Pocket.svg"><a></a></li><li><a href="https://news.ycombinator.com/submitlink?u=https://remusao.github.io//posts/synacor-down-the-rabbit-hole.html&t=Synacor - Down the Rabbit Hole" title="Submit to Hacker News" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Hacker News" src="/images/social_flat_rounded_rects_svg/HackerNews.svg"><a></a></li><li><a href="https://www.reddit.com/submit?url=https://remusao.github.io//posts/synacor-down-the-rabbit-hole.html&title=Synacor - Down the Rabbit Hole" title="Submit to Reddit" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Reddit" src="/images/social_flat_rounded_rects_svg/Reddit.svg"><a></a></li></ul></div></footer></main></body></html>