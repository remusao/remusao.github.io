<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Decompressing BZipped Files With Julia</title><meta name="description" content="Simplex Sigillum Veri"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="canonical" href="https://remusao.github.io/posts/decompressing-bz2-files-with-julia.html"><link rel="icon" type="image/x-icon" href="/images/favicon.ico"><style type="text/css">@font-face{font-display:swap;font-family:'Open Sans';font-style:italic;font-weight:400;src:url(/fonts/OpenSans_italic_400.woff2) format('woff2')}@font-face{font-display:swap;font-family:'Open Sans';font-style:italic;font-weight:700;src:url(/fonts/OpenSans_italic_700.woff2) format('woff2')}@font-face{font-display:swap;font-family:'Open Sans';font-style:normal;font-weight:400;src:url(/fonts/OpenSans_normal_400.woff2) format('woff2')}@font-face{font-display:swap;font-family:'Open Sans';font-style:normal;font-weight:700;src:url(/fonts/OpenSans_normal_700.woff2) format('woff2')}body{color:#2f2f2f;font-family:'Open Sans',sans-serif;font-size:95%;line-height:1.6em;margin:20px auto;max-width:42em;padding:0 1em}@media (min-width:760px){body{font-size:100%}}@media (min-width:1024px){body{font-size:105%}}h1,h2,h3{font-size:1.7em;font-weight:400;padding-top:.7em}h2,h3{font-size:1.5em}h3{font-size:1.2em}.header,.main figcaption{color:#555;font-style:italic}.main a{color:#3465a4}.main a:visited{color:#75507b}.main figcaption{color:#696f72;line-height:2em;text-align:center}.main img{display:block;height:auto;margin:auto;padding-bottom:1em;padding-top:1em;width:90%}.main blockquote{border-left:thin solid #d3d7cf;color:#555;margin:10px;padding:0 0 0 1em}@font-face{font-display:swap;font-family:'Inconsolata';font-style:normal;font-weight:400;src:url(/fonts/Inconsolata.woff2) format('truetype')}code{background-color:#f3f4f5;font-family:'Inconsolata';line-height:1.2em}pre code{display:block;overflow-x:auto;padding:8px}.leave-comment-btn,summary{font-size:15px;font-weight:600}.leave-comment-btn{background-color:#28a745;background-image:linear-gradient(-180deg,#34d058,#28a745 90%);border:1px solid rgba(27,31,35,.2);border-radius:.25em;color:#fff;display:inline-block;margin-top:1.5em;padding:3px 10px;text-decoration:none}.leave-comment-btn:hover{box-shadow:0 1px 3px rgba(0,0,0,.24)}summary{color:#516ae8;cursor:pointer;line-height:1.2rem;margin-top:2rem}.comments-list{list-style:none;padding:0}.comment{background-color:#fff;border:1px solid #d1d5da;border-radius:3px;color:#24292e;font-size:15px;margin:1em 0}.meta{background-color:#f6f8fa;border-bottom:1px solid #d1d5da;color:#586069}.author,.date{text-decoration:none}.author{color:#24292e!important;font-weight:700}.date{color:#586069}.date:hover{color:#0366d6}.content{padding-left:20px}.avatar,.emoji{vertical-align:middle}.avatar{display:inline-block;margin-right:5px}.emoji{height:1.1em;width:1.1em}table{border-collapse:collapse;margin:auto}td,th{border:1px solid #ddd;padding:10px}tr:hover{background-color:#f5f5f5}footer{border-top:thin solid #d3d7cf;margin:1.5em 0}.share ul{text-align:right}.share li{display:inline;padding:0 5px}.share img{width:2em}.main a,header a{text-decoration:none}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag{color:#333;font-weight:700}.hljs-subst{color:#333}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style></head><body><main><header><h1><a href="../"><span>../</span></a></h1></header><h1>Decompressing BZipped Files With Julia</h1><section class="header"><div>2014-07-22 | <em>Reading time: ~4 minutes</em></div></section><article><div class="main"><p>I’m currently working with Wikipedia dumps, and to save space, it’s a good thing to make scripts that read directly content from (and write results to) BZipped files.</p><h2 id="setup">Setup</h2><p>Tests where executed on my personnal computer:</p><ul><li>i7</li><li>16GB of ram</li></ul><p>On a small Wikipedia dump of <em>407MB</em>. All timings are in <em>seconds</em>.</p><h2 id="bzcat-alone">bzcat alone</h2><p>To have a point of comparison, I decompressed the dump using <em>bzcat</em> alone. The timing is <em>64 seconds</em>.</p><pre><code class="language-sh">$ time 1&gt;/dev/null bzcat wikidump.xml.bz2</code></pre><h2 id="using-python">Using Python</h2><p>It’s easy enough with <em>Python</em> thanks to the <code>bz2</code> module that allows to transparently manipulate a compressed file as if it were a normal opened file. Before jumping to Julia, let see how it is done in Python:</p><pre><code class="language-python"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> bz2


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span>
    in_stream = bz2.BZ2File(sys.argv[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> in_stream:
        print(line)
    in_stream.close()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()</code></pre><p>Nothing easier, it takes <em>85 seconds</em> to run.</p><h2 id="what-about-julia">What about Julia?</h2><p>Since I really love <em>Julia</em> language, I was tempted to do the same with Julia. Here are the differents solutions that I went through, with their respective timings.</p><h3 id="using-bz2-python-module-through-pycall">Using bz2 Python module through PyCall</h3><p>The first naive option is to use the original module from Python. It’s easy enough using the <code>PyCall</code> module. We can install it like so:</p><pre><code class="language-julia">julia&gt; Pkg.add(<span class="hljs-string">"PyCall"</span>)
julia&gt; Pkg.update()</code></pre><p>The script:</p><pre><code class="language-julia"><span class="hljs-keyword">using</span> PyCall
<span class="hljs-meta">@pyimport</span> bz2

<span class="hljs-keyword">function</span> main()
    in_stream = bz2.BZ2File(<span class="hljs-literal">ARGS</span>[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> in_stream
        println(line)
    <span class="hljs-keyword">end</span>
    in_stream[:close]()
<span class="hljs-keyword">end</span></code></pre><p>But then we hit the wall… timing is: <em>1352 seconds</em>. This is likely due to the conversion between <em>Python</em> and <em>Julia</em> datatypes. So not the best option for a data-intensive usage.</p><h3 id="piping-result-of-bzcat-to-julia">Piping result of bzcat to Julia</h3><p>The second option that came to my mind was: “why not using <em>bzcat</em>?”. It’s easy enough, we just have to read from <code>STDIN</code>:</p><pre><code class="language-julia"><span class="hljs-keyword">function</span> main()
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> eachline(<span class="hljs-literal">STDIN</span>)
        print(line)
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><p>Here is the invocation:</p><pre><code class="language-sh">$ bzcat wikidump.xml.bz2 | julia bz2_bench.jl</code></pre><p>Timing is now a more reasonable <em>72 seconds</em>. So that is less than the <em>Python</em> version shown above. But this is not satisfactory enough. Why not use the wonderful capabilities of <em>Julia</em> to run external commands an pipe results?</p><h3 id="invoking-bzcat-from-julia">Invoking bzcat from Julia</h3><p>It is easy to invoke commands from inside <em>Julia</em> using backquotes: <code>run(`cmd`)</code> and <code>|&gt;</code> to pipe between commands and streams. Let’s do it:</p><pre><code class="language-julia"><span class="hljs-keyword">function</span> main()
    file = <span class="hljs-literal">ARGS</span>[<span class="hljs-number">1</span>]
    run(<span class="hljs-string">`bzcat <span class="hljs-subst">$(file)</span>`</span> |&gt; <span class="hljs-literal">STDOUT</span>)
<span class="hljs-keyword">end</span></code></pre><p>The script is equivalent to: <code>bzcat wikidump.xml.bz2</code>, but it’s quite impressive to see how easy it is to do this inside a Julia script. This time is about <em>66 seconds</em>, more or less the same than with the external piping from <code>bzcat</code>.</p><p>But it would be useful to get lines of contents from the stream, like it was in the original <em>Python</em> script. For this task, <em>Julia</em> standard library offers a multitudes of handy functions. The one we will use is <code>readsfrom</code> that returns two things: stdout of the given process, and the process itself. Here it is in action:</p><pre><code class="language-julia"><span class="hljs-keyword">function</span> main()
    file = <span class="hljs-literal">ARGS</span>[<span class="hljs-number">1</span>]
    stdout, p = readsfrom(<span class="hljs-string">`bzcat <span class="hljs-subst">$(file)</span>`</span>)
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> eachline(stdout)
        print(line)
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><p>Timing is now about <em>74 seconds</em>, this is <em>10 seconds</em> faster than the first <em>Python</em> version. But we don’t rely on a module. Instead, we make use of the ability to play with command invocations, stream pipings, and the like that <em>Julia</em> allows.</p><h2 id="timings">Timings</h2><figure><a href="../images/bz2-julia-bench.png"><img src="../images/bz2-julia-bench.png" alt="Bench"></a><figcaption>Timings.</figcaption></figure><p>Timings are relatively close since the big work is done in the decompression, that’s why there isn’t much difference between <em>Julia</em> and <em>Python</em>.</p><h2 id="conclusion">Conclusion</h2><p>I was first tempted to implement a <em>Julia</em> wrapper over <em>bzlib</em>, but what for? When it’s so easy to invoke external commands and manipulate their input and output streams. <em>Julia</em> is a young language, but it’s so flexible and extensible, that often I forget about it!</p></div><div class="comments"></div></article><footer><div class="share"><ul><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://remusao.github.io//posts/decompressing-bz2-files-with-julia.html&t=Decompressing BZipped Files With Julia" title="Share on Facebook" target="_blang" rel="noopener noreferrer"><img loading="lazy" alt="Share on Facebook" src="/images/social_flat_rounded_rects_svg/Facebook.svg"><a></a></li><li><a href="https://twitter.com/share?url=https://remusao.github.io//posts/decompressing-bz2-files-with-julia.html&text=Decompressing BZipped Files With Julia&via=Pythux" title="Tweet" target="_blang" rel="noopener noreferrer"><img loading="lazy" alt="Tweet" src="/images/social_flat_rounded_rects_svg/Twitter.svg"><a></a></li><li><a href="https://getpocket.com/save?url=https://remusao.github.io//posts/decompressing-bz2-files-with-julia.html&title=Decompressing BZipped Files With Julia" title="Add to Pocket" target="_blang" rel="noopener noreferrer"><img loading="lazy" alt="Add to Pocket" src="/images/social_flat_rounded_rects_svg/Pocket.svg"><a></a></li><li><a href="https://news.ycombinator.com/submitlink?u=https://remusao.github.io//posts/decompressing-bz2-files-with-julia.html&t=Decompressing BZipped Files With Julia" title="Submit to Hacker News" target="_blang" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Hacker News" src="/images/social_flat_rounded_rects_svg/HackerNews.svg"><a></a></li><li><a href="https://www.reddit.com/submit?url=https://remusao.github.io//posts/decompressing-bz2-files-with-julia.html&title=Decompressing BZipped Files With Julia" title="Submit to Reddit" target="_blang" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Reddit" src="/images/social_flat_rounded_rects_svg/Reddit.svg"><a></a></li></ul></div></footer></main></body></html>