<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Generating Ad-Blocker filters from whotracks.me data</title><meta name="description" content="Simplex Sigillum Veri"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="canonical" href="https://remusao.github.io/posts/whotracksme-generate-adb-filters.html"><link rel="icon" type="image/x-icon" href="/images/favicon.ico"><style type="text/css">body{color:#2f2f2f;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen-Sans,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;line-height:1.6em;margin:20px auto;max-width:40rem;padding:0 1.5em;text-rendering:optimizeLegibility}h1{line-height:1.1em}h2{border-bottom:1px solid #eaecef;padding-bottom:.5em}h1,h2,h3{padding-top:.7em}.header{color:#555;margin-top:-.8em}.main a{color:#3465a4}.main a:visited{color:#75507b}.main figcaption{color:#696f72;font-style:italic;line-height:2em;text-align:center}.main img{display:block;height:auto;margin:auto;padding-bottom:1em;padding-top:1em;width:90%}.main blockquote{border-left:thin solid #d3d7cf;color:#555;margin:10px;padding:0 0 0 1em}code{background-color:#f6f8fa;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:14px;line-height:20px;padding:.2em .4em}pre code{display:block;overflow-x:auto}.leave-comment-btn,summary{font-size:16px;font-weight:600}.leave-comment-btn{background-color:#28a745;background-image:linear-gradient(-180deg,#34d058,#28a745 90%);border:1px solid rgba(27,31,35,.2);border-radius:.25em;color:#fff;display:inline-block;margin-top:1.5em;padding:3px 10px;text-decoration:none}.leave-comment-btn:hover{box-shadow:0 1px 3px rgba(0,0,0,.24)}summary{color:#516ae8;cursor:pointer;line-height:1.2rem;margin-top:2rem}.comments-list{list-style:none;padding:0}.comment{background-color:#fff;border:1px solid #d1d5da;border-radius:3px;color:#24292e;font-size:16px;margin:1em 0}.meta{background-color:#f6f8fa;border-bottom:1px solid #d1d5da;color:#586069}.author,.date{text-decoration:none}.author{color:#24292e!important;font-weight:700}.date{color:#586069}.date:hover{color:#0366d6}.content{padding-left:20px}.avatar,.emoji{vertical-align:middle}.avatar{display:inline-block;margin-right:5px}.emoji{height:1.1em;width:1.1em}table{border-collapse:collapse;margin:auto}td,th{border:1px solid #ddd;padding:10px}tr:hover{background-color:#f5f5f5}footer{border-top:thin solid #d3d7cf;margin:1.5em 0}.share ul{text-align:right}.share li{display:inline;padding:0 5px}.share img{width:32px}.main a,header a{text-decoration:none}.hljs{background:#f8f8f8;color:#333;display:block;overflow-x:auto;padding:.5em}.hljs-comment,.hljs-quote{color:#6a737d;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#d73a49}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:#005cc5}.hljs-doctag,.hljs-string{color:#032f62}.hljs-section,.hljs-selector-id,.hljs-title{color:#900}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#6f42c1}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style></head><body><main><header><h1><a href="../"><span>../</span></a></h1></header><h1>Generating Ad-Blocker filters from whotracks.me data</h1><section class="header"><div>└─ 2017-11-22 • <em>Reading time: ~9 minutes</em></div></section><article><div class="main"><p><strong>Disclaimer</strong>: This article has originally been written for, and published on <a href="https://whotracks.me/blog/generating_adblocker_filters.html">whotracks.me</a>.</p><p><em>TL;DR</em> In this post we see how to:</p><ol><li>Load the data from <a href="https://github.com/cliqz-oss/whotracks.me">whotracks.me</a> to get access to trackers’ information</li><li>Create a mapping from tracking categories to list of domains</li><li>Filter each domain based on the amount of tracking of each <em>app</em></li><li>Generate a filter list for each category</li></ol><p>The full source code used in this article can be found on the <a href="https://github.com/cliqz-oss/whotracks.me/blob/master/contrib/generating_adblocker_filters.py">Github repository</a>.</p><p>Most popular content blockers are using filter lists to decide what requests leaving the browser should be blocked. In this regard, filter lists act as a privacy <em>ground truth</em>: deciding what is safe, and what is not safe for users. It means that your privacy protection is only as good as the filters your are using. The community is doing an amazing job, but still there can be gaps in your protection; one such situation is when a new tracker appears.</p><p>With the right data, updated regularly, we believe it is possible to build powerful tools to help increase users’ privacy. Knowing more about trackers, in real time, allows to provide better anti-tracking but can also <em>help</em> the tedious process of curating the filter lists.</p><p>In this post we’d like to demonstrate how we can make use of the open-sourced <a href="https://whotracks.me">whotracks.me</a> data to automatically generate <em>up-to-date</em>, <em>per-category</em>, filter lists supported by the most popular ad-blockers out there. Leveraging this data can improve user experience and make maintaining the lists easier.</p><p>In the future, we can imagine generating per-country lists as well, in the spirit of the different <a href="https://easylist.to/">easylists</a> already in existence:</p><ul><li><code>DEU: Pornvertising blocking Germany</code></li><li><code>DEU: Site_Analytics blocking Germany</code></li><li>…</li><li><code>FR: Site_Analytics blocking France</code></li></ul><p>They could also be dispatched in the already existing lists such as <code>advertising</code>, <code>privacy</code>, etc. Another option could be to use this as a tool to assist maintainers to keep an eye on the ecosystem; allowing to learn about new trackers in real time.</p><p>Let’s get started!</p><h2 id="loading-the-data">Loading the data</h2><p>The first step is to install the <code>whotracksme</code> package, available on <a href="https://pypi.python.org/pypi/whotracksme">PyPI</a> and <a href="https://github.com/cliqz-oss/whotracks.me">Github</a>. You can get started by installing <code>whotracksme</code> with <code>pip</code>:</p><pre><code class="language-sh">$ pip install whotracksme</code></pre><p>We start by loading the tracker-related data from <a href="https://github.com/cliqz-oss/whotracks.me/blob/master/whotracksme/data/assets/trackerdb.sql">trackerdb.sql</a>, using the helper function found in the <code>whotracksme.data</code> module:</p><pre><code class="language-python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict
<span class="hljs-keyword">from</span> whotracksme.data <span class="hljs-keyword">import</span> load_tracker_db

<span class="hljs-comment"># Categories to tracker domains</span>
tracker_domains_per_category = defaultdict(list)

<span class="hljs-comment"># Keep track of normalized "app" name for each tracker domain. A given "app"</span>
<span class="hljs-comment"># such as "doubleclick" can use several domains: 2mdn.net, doubleclick.net, etc.</span>
tracker_domains_to_app = {}

<span class="hljs-comment"># Load trackers and group them by category</span>
sql_query = <span class="hljs-string">"""
  SELECT categories.name, tracker, domain FROM tracker_domains
  INNER JOIN trackers ON trackers.id = tracker_domains.tracker
  INNER JOIN categories ON categories.id = trackers.category_id;
"""</span>
<span class="hljs-keyword">with</span> load_tracker_db() <span class="hljs-keyword">as</span> connection:
    <span class="hljs-keyword">for</span> (category, tracker, domain) <span class="hljs-keyword">in</span> connection.execute(sql_query):
        tracker_domains_per_category[category].append(domain)
        tracker_domains_to_app[domain] = tracker</code></pre><p>Here is a sample of what we get in <code>tracker_domains_per_category</code>. Note that if you run the same script, you might get slightly different results as the data is being constantly updated:</p><blockquote><pre><code class="language-python">defaultdict(list, {
  <span class="hljs-string">'advertising'</span>: [
    <span class="hljs-string">'doubleclick.net'</span>,
    ...
  ],
  <span class="hljs-string">'audio_video_player'</span>: [
    <span class="hljs-string">'soundcloud.com'</span>
    ...
  ],
  <span class="hljs-string">'cdn'</span>: [
    <span class="hljs-string">'googleapis.com'</span>,
    ...
  ],
  <span class="hljs-string">'comments'</span>: [
    <span class="hljs-string">'disqus.com'</span>,
    ...
  ],
  <span class="hljs-string">'customer_interaction'</span>: [
    <span class="hljs-string">'zendesk.com'</span>,
    ...
  ],
  <span class="hljs-string">'essential'</span>: [
    <span class="hljs-string">'googletagmanager.com'</span>,
    ...
  ],
  <span class="hljs-string">'extensions'</span>: [
    <span class="hljs-string">'kaspersky-labs.com'</span>,
    ...
  ],
  <span class="hljs-string">'hosting'</span>: [
    <span class="hljs-string">'amazonaws.com'</span>,
    ...
  ],
  <span class="hljs-string">'misc'</span>: [
    <span class="hljs-string">'linkedin.com'</span>,
    ...
  ],
  <span class="hljs-string">'pornvertising'</span>: [
    <span class="hljs-string">'pornhub.com'</span>,
    ...
  ],
  <span class="hljs-string">'site_analytics'</span>: [
    <span class="hljs-string">'google-analytics.com'</span>,
    ...
  ],
  <span class="hljs-string">'social_media'</span>: [
    <span class="hljs-string">'twitter.com'</span>,
    ...
  ]
]})</code></pre></blockquote><h2 id="filtering-based-on-tracking-behavior">Filtering based on tracking behavior</h2><p>It is tempting to generate filters for each domain loaded so far, but it would be very aggressive. Indeed, some domains identified as potential trackers might in fact not send <a href="https://whotracks.me/blog/what_is_a_tracker.html">unsafe identifiers</a> (or not a lot). For example <a href="https://whotracks.me/trackers/createjs.html">createjs</a> is not using any <em>fingerprinting</em> and does not seem to be doing tracking via <em>cookies</em>, hence, it should not be blocked systematically.</p><p>Fortunately, we can make use of the data from <a href="https://github.com/cliqz-oss/whotracks.me/blob/master/whotracksme/data/assets/apps.json">apps.json</a> to learn more about each tracker. An <em>app</em> is an entity which can contain several domains (e.g.: <em>doubleclick</em> is an <em>app</em> for which we identified three domains: <code>2mdn.net</code>, <code>invitemedia.com</code> and <code>doubleclick.net</code>). We also provide information about companies to which each app belongs, but we will leave the exploration of this data for another article.</p><pre><code class="language-python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> whotracksme.data <span class="hljs-keyword">import</span> load_apps

apps = load_apps()</code></pre><p><code>apps</code> is a dictionary with keys being <em>app ids</em> (e.g.: <code>google_analytics</code>) and values containing all we know about each <em>app</em>. Let’s take an example:</p><pre><code class="language-json">apps[&quot;google_analytics&quot;]

{
    &quot;overview&quot;: {
        &quot;bad_qs&quot;: 0.4377430033329568,
        &quot;content_length&quot;: 14771.492718357234,
        &quot;cookies&quot;: 0.0015869678941083753,
        &quot;https&quot;: 0.7507222054912428,
        &quot;id&quot;: &quot;google_analytics&quot;,
        &quot;reach&quot;: 0.44292899275150094,
        &quot;requests&quot;: 3.834100333790446,
        &quot;requests_tracking&quot;: 1.202157901660253,
        &quot;site_reach&quot;: 0.616005569531587,
        &quot;tracked&quot;: 0.4383474801843971
    },
    &quot;history&quot;: ...,
    &quot;rank&quot;: ...,
    &quot;sites&quot;: ...
}</code></pre><p>That’s a lot of data, and we plan to release a more complete documentation about what all this is about soon. For now let’s just say that everything is already made accessible on the website, in form of nice graphs and aggregations!</p><p>For our use-case, we will only consider the field: <code>tracked</code>. It represents the proportion of page loads including <em>app</em>, identified as performing some form of tracking (using either identifying <em>cookies</em> or <em>fingerprinting</em>). In the case of <code>google_analytics</code>, it means that out of 100 page loads where <code>google_analytics</code> was present, tracking occurred 44 times.</p><p>Before generating the filter list, let’s keep only <em>apps</em> tracking users more than <code>10%</code> of the time. Please note that finding the right threshold would require some finer analysis, and could depend on the application.</p><pre><code class="language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">filter_domains</span>(<span class="hljs-params">domains</span>):</span>
    <span class="hljs-keyword">for</span> domain <span class="hljs-keyword">in</span> domains:
        app_name = tracker_domains_to_app[domain]
        <span class="hljs-keyword">if</span> app_name <span class="hljs-keyword">in</span> apps:
            app = apps[tracker_domains_to_app[domain]]
            tracked = app[<span class="hljs-string">'overview'</span>][<span class="hljs-string">'tracked'</span>]
            <span class="hljs-keyword">if</span> tracked &gt;= <span class="hljs-number">0.1</span>:
                <span class="hljs-keyword">yield</span> domain</code></pre><p>We need to check if the <em>app</em> exists first because we currently only have the top 500 hosted on Github. We will host more in the future.</p><h2 id="generating-the-lists">Generating the lists</h2><p>We now proceed to generate the filter lists from these domains. They can take two forms:</p><ul><li>ADB compatible syntax: <code>||{domain}$third-party</code></li><li>Hostname syntax: <code>127.0.0.1 {domain}</code></li></ul><p>Note that the second option will probably be too aggressive in a lot of cases, as it will also block the domain even if they are first-party (e.g., <code>google.com</code> might get blocked by these rules).</p><pre><code class="language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_adb_filters</span>(<span class="hljs-params">domains</span>):</span>
    <span class="hljs-string">"""Given a list of domains, generate filters using the
    ADB syntax to be used in an adblocker"""</span>
    <span class="hljs-keyword">for</span> domain <span class="hljs-keyword">in</span> domains:
        <span class="hljs-keyword">yield</span> <span class="hljs-string">f"||<span class="hljs-subst">{domain}</span>$third-party"</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_hostname_filters</span>(<span class="hljs-params">domains</span>):</span>
    <span class="hljs-string">"""Given a list of domains, generate filters using
    the hostname syntax"""</span>
    <span class="hljs-keyword">for</span> domain <span class="hljs-keyword">in</span> domains:
        <span class="hljs-keyword">yield</span> <span class="hljs-string">f"127.0.0.1 <span class="hljs-subst">{domain}</span>"</span>

<span class="hljs-comment"># Generate filters with *ADB* syntax</span>
adb_filters = {
    category: <span class="hljs-string">'\n'</span>.join(generate_adb_filters(filter_domains(domains)))
    <span class="hljs-keyword">for</span> (category, domains) <span class="hljs-keyword">in</span> tracker_domains_per_category.items()
}

<span class="hljs-comment"># Generate filters with *hostname* syntax</span>
hostname_filters = {
    category: <span class="hljs-string">'\n'</span>.join(generate_hostname_filters(filter_domains(domains)))
    <span class="hljs-keyword">for</span> (category, domains) <span class="hljs-keyword">in</span> tracker_domains_per_category.items()
}</code></pre><p>Each dictionary now contains a valid adblocking list for each category:</p><pre><code class="language-python">hostname_filters.keys()</code></pre><blockquote><pre><code class="language-python">dict_keys([
  <span class="hljs-string">'advertising'</span>,
  <span class="hljs-string">'audio_video_player'</span>,
  <span class="hljs-string">'cdn'</span>,
  <span class="hljs-string">'comments'</span>,
  <span class="hljs-string">'customer_interaction'</span>,
  <span class="hljs-string">'essential'</span>,
  <span class="hljs-string">'extensions'</span>,
  <span class="hljs-string">'hosting'</span>,
  <span class="hljs-string">'misc'</span>,
  <span class="hljs-string">'pornvertising'</span>,
  <span class="hljs-string">'site_analytics'</span>,
  <span class="hljs-string">'social_media'</span>,
  <span class="hljs-string">'unknown'</span>
])</code></pre></blockquote><p>And here is what we get for example in the <code>advertising</code> category:</p><pre><code class="language-python">print(adb_filters[<span class="hljs-string">'advertising'</span>])</code></pre><blockquote><pre><code class="language-sh">||doubleclick.com<span class="hljs-variable">$third</span>-party
||criteo.com<span class="hljs-variable">$third</span>-party
...</code></pre></blockquote><p>And the same domains but as <code>hostname</code> filters:</p><pre><code class="language-python">print(hostname_filters[<span class="hljs-string">'advertising'</span>])</code></pre><blockquote><pre><code class="language-sh">127.0.0.1 doubleclick.com
127.0.0.1 criteo.com
...</code></pre></blockquote><p>To put it in a nutshell, here is what we just did:</p><ol><li>Load the data from <a href="https://github.com/cliqz-oss/whotracks.me">whotracks.me</a> to get access to trackers’ information</li><li>Create a mapping from tracking categories to list of domains</li><li>Filter each domain based on the amount of tracking of each <em>app</em></li><li>Generate a filter list for each category</li></ol><p>There is so much more we can do with this database. At the moment the API to load the data is pretty-low level, but it will be improved over time.</p></div><div class="comments"><span><a class="leave-comment-btn" href="https://github.com/remusao/remusao.github.io/issues/2" title="https://github.com/remusao/remusao.github.io/issues/2" target="_blank" rel="noopener noreferrer">Leave a comment on GitHub</a></span></div></article><footer><div class="share"><ul><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://remusao.github.io//posts/whotracksme-generate-adb-filters.html&t=Generating Ad-Blocker filters from whotracks.me data" title="Share on Facebook" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Share on Facebook" src="/images/social_flat_rounded_rects_svg/Facebook.svg"><a></a></li><li><a href="https://twitter.com/share?url=https://remusao.github.io//posts/whotracksme-generate-adb-filters.html&text=Generating Ad-Blocker filters from whotracks.me data&via=Pythux" title="Tweet" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Tweet" src="/images/social_flat_rounded_rects_svg/Twitter.svg"><a></a></li><li><a href="https://getpocket.com/save?url=https://remusao.github.io//posts/whotracksme-generate-adb-filters.html&title=Generating Ad-Blocker filters from whotracks.me data" title="Add to Pocket" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Add to Pocket" src="/images/social_flat_rounded_rects_svg/Pocket.svg"><a></a></li><li><a href="https://news.ycombinator.com/submitlink?u=https://remusao.github.io//posts/whotracksme-generate-adb-filters.html&t=Generating Ad-Blocker filters from whotracks.me data" title="Submit to Hacker News" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Hacker News" src="/images/social_flat_rounded_rects_svg/HackerNews.svg"><a></a></li><li><a href="https://www.reddit.com/submit?url=https://remusao.github.io//posts/whotracksme-generate-adb-filters.html&title=Generating Ad-Blocker filters from whotracks.me data" title="Submit to Reddit" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Reddit" src="/images/social_flat_rounded_rects_svg/Reddit.svg"><a></a></li></ul></div></footer></main></body></html>