<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>TIL—Python has a built-in persistent key-value store</title><meta name="description" content="Simplex Sigillum Veri"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="canonical" href="https://remusao.github.io/posts/python-dbm-module.html"><link rel="icon" type="image/x-icon" href="/images/favicon.ico"><style type="text/css">body{color:#2f2f2f;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen-Sans,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;line-height:1.6em;margin:20px auto;max-width:40rem;padding:0 1.5em;text-rendering:optimizeLegibility}h1{line-height:1.1em}h2{border-bottom:1px solid #eaecef;padding-bottom:.5em}h1,h2,h3{padding-top:.7em}.header{color:#555;margin-top:-.8em}.main a{color:#3465a4}.main a:visited{color:#75507b}.main figcaption{color:#696f72;font-style:italic;line-height:2em;text-align:center}.main img{display:block;height:auto;margin:auto;padding-bottom:1em;padding-top:1em;width:90%}.main blockquote{border-left:thin solid #d3d7cf;color:#555;margin:10px;padding:0 0 0 1em}code{background-color:#f6f8fa;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:14px;line-height:20px;padding:.2em .4em}pre code{display:block;overflow-x:auto}.leave-comment-btn,summary{font-size:16px;font-weight:600}.leave-comment-btn{background-color:#28a745;background-image:linear-gradient(-180deg,#34d058,#28a745 90%);border:1px solid rgba(27,31,35,.2);border-radius:.25em;color:#fff;display:inline-block;margin-top:1.5em;padding:3px 10px;text-decoration:none}.leave-comment-btn:hover{box-shadow:0 1px 3px rgba(0,0,0,.24)}summary{color:#516ae8;cursor:pointer;line-height:1.2rem;margin-top:2rem}.comments-list{list-style:none;padding:0}.comment{background-color:#fff;border:1px solid #d1d5da;border-radius:3px;color:#24292e;font-size:16px;margin:1em 0}.meta{background-color:#f6f8fa;border-bottom:1px solid #d1d5da;color:#586069}.author,.date{text-decoration:none}.author{color:#24292e!important;font-weight:700}.date{color:#586069}.date:hover{color:#0366d6}.content{padding-left:20px}.avatar,.emoji{vertical-align:middle}.avatar{display:inline-block;margin-right:5px}.emoji{height:1.1em;width:1.1em}table{border-collapse:collapse;margin:auto}td,th{border:1px solid #ddd;padding:10px}tr:hover{background-color:#f5f5f5}footer{border-top:thin solid #d3d7cf;margin:1.5em 0}.share ul{text-align:right}.share li{display:inline;padding:0 5px}.share img{width:32px}.main a,header a{text-decoration:none}.hljs{background:#f8f8f8;color:#333;display:block;overflow-x:auto;padding:.5em}.hljs-comment,.hljs-quote{color:#6a737d;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#d73a49}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:#005cc5}.hljs-doctag,.hljs-string{color:#032f62}.hljs-section,.hljs-selector-id,.hljs-title{color:#900}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#6f42c1}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style></head><body><main><header><h1><a href="../"><span>../</span></a></h1></header><h1>TIL—Python has a built-in persistent key-value store</h1><section class="header"><div>└─ 2018-06-10 • <em>Reading time: ~2 minutes</em></div></section><article><div class="main"><p>Python is, in a lot of ways, a very rich language. After years of using it, I still regularly discover new parts of the ecosystem, even in the standard library. In particular, there are a few modules which are not very well-known, but can be very useful in some situations. Today I discovered <code>dbm</code> a persistent key/value store:</p><p>Quick start:</p><pre class="code" data-lang="python"><code><span class="hljs-keyword">import</span> dbm

<span class="hljs-keyword">with</span> open(<span class="hljs-string">'my_store'</span>, <span class="hljs-string">'c'</span>) <span class="hljs-keyword">as</span> db:
  db[<span class="hljs-string">'key'</span>] = <span class="hljs-string">'value'</span>
  print(db.keys()) <span class="hljs-comment"># ['key']</span>
  print(db[<span class="hljs-string">'key'</span>]) <span class="hljs-comment"># 'value'</span>
  print(<span class="hljs-string">'key'</span> <span class="hljs-keyword">in</span> db) <span class="hljs-comment"># True</span>
</code></pre><p>It behaves a lot like a <code>dict</code> except:</p><ul><li>It persists its values on disk</li><li>You can only use <code>str</code> or <code>bytes</code> as key and values</li></ul><p>The performance is also slower than a dictionary, but faster than <code>sqlite3</code>.</p><p>The benchmark consists in performing <em>10k</em> writes and <em>10k</em> random reads:</p><pre class="code" data-lang="python"><code><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> time

operations = <span class="hljs-number">10000</span>
writes = [str(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(operations)]
reads = [str(int(random() * operations)) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(operations)]

<span class="hljs-comment"># Create some records</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> writes:
    db[i] = <span class="hljs-string">'x'</span>

<span class="hljs-comment"># Read values in random order</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> reads:
    x = db[i]
</code></pre><p>Here are the results:</p><ul><li><code>dict</code> – total: <em>0.002 seconds</em>, 0.23398 μs/record <strong>x 1</strong></li><li><code>dbm</code> – total: 0.054 seconds, 5.35984 μs/record <strong>x 27</strong></li><li><code>sqlite3</code> in-memory: total: 2.468 seconds, 246.84346 μs/record <strong>x 1234</strong></li><li><code>sqlite3</code> file: total 42.407 seconds, 4240.69593 μs/record <strong>x 21207</strong></li></ul><p>Why is <code>sqlite3</code> so slow? Well, the benchmark is probably not representative of the typical workload for sqlite (lots of individual insertions and selections). If we perform the same operations using <code>executemany</code> and one <code>select</code> of all the keys at once, we get:</p><ul><li><code>:memory:</code> – total: 0.038 seconds, 3.81415 μs/record <strong>x 19</strong></li><li><code>file</code> – total 0.071 seconds, 7.07369 μs/record <strong>x 35</strong></li></ul><p>It’s much better, but still not as fast as <code>dbm</code> (when we persist to a file). So, if you have a workload where keys and values are added and retrieved very often, are always <code>str</code> or <code>bytes</code> and need to be persisted on disk, <code>dbm</code> is a serious contender!</p><p><em>The code used to benchmark can be found here: <a href="../snippets/dbm_bench.py">dbm_bench.py</a></em></p></div><div class="comments"><span><a class="leave-comment-btn" href="https://github.com/remusao/remusao.github.io/issues/15" title="https://github.com/remusao/remusao.github.io/issues/15" target="_blank" rel="noopener noreferrer">Leave a comment on GitHub</a></span></div></article><footer><div class="share"><ul><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://remusao.github.io//posts/python-dbm-module.html&t=TIL—Python has a built-in persistent key-value store" title="Share on Facebook" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Share on Facebook" src="/images/social_flat_rounded_rects_svg/Facebook.svg"><a></a></li><li><a href="https://twitter.com/share?url=https://remusao.github.io//posts/python-dbm-module.html&text=TIL—Python has a built-in persistent key-value store&via=Pythux" title="Tweet" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Tweet" src="/images/social_flat_rounded_rects_svg/Twitter.svg"><a></a></li><li><a href="https://getpocket.com/save?url=https://remusao.github.io//posts/python-dbm-module.html&title=TIL—Python has a built-in persistent key-value store" title="Add to Pocket" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Add to Pocket" src="/images/social_flat_rounded_rects_svg/Pocket.svg"><a></a></li><li><a href="https://news.ycombinator.com/submitlink?u=https://remusao.github.io//posts/python-dbm-module.html&t=TIL—Python has a built-in persistent key-value store" title="Submit to Hacker News" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Hacker News" src="/images/social_flat_rounded_rects_svg/HackerNews.svg"><a></a></li><li><a href="https://www.reddit.com/submit?url=https://remusao.github.io//posts/python-dbm-module.html&title=TIL—Python has a built-in persistent key-value store" title="Submit to Reddit" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="Submit to Reddit" src="/images/social_flat_rounded_rects_svg/Reddit.svg"><a></a></li></ul></div></footer></main></body></html>